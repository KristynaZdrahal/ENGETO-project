--Výstup  1.tabulka

CREATE TABLE t_kristyna_zdrahalova_project_SQL_final_primary AS
WITH yearly_price_avg AS (
    SELECT 
        YEAR(date_from) AS year, 
        category_code, 
        AVG(value) AS avg_price
    FROM 
        czechia_price
    GROUP BY 
        YEAR(date_from), 
        category_code
),
yearly_wage_avg AS (
    SELECT 
        payroll_year AS year, 
        AVG(value) AS avg_wage
    FROM 
        czechia_payroll
    GROUP BY 
        payroll_year
)
SELECT 
    p.year,
    p.category_code,
    ROUND(p.avg_price, 2) AS avg_price,
    ROUND(w.avg_wage, 2) AS avg_wage
FROM 
    yearly_price_avg p
JOIN 
    yearly_wage_avg w ON p.year = w.year
WHERE 
    p.year BETWEEN 2006 AND 2018
ORDER BY 
    p.year, 
    p.category_code;

--Výstup- tabulka č.2

CREATE TABLE t_kristyna_zdrahalova_SQL_project_final_secondary AS
WITH RankedData AS (
    SELECT 
        e.country, 
        e.year, 
        e.GDP, 
        e.taxes, 
        ROW_NUMBER() OVER (PARTITION BY e.country ORDER BY e.year) AS rn
    FROM 
        economies e
    WHERE 
        e.country IN (
            SELECT 
                c.country
            FROM 
                countries c
            WHERE 
                c.continent LIKE 'Europe'
        )
        AND e.year BETWEEN 2006 AND 2018
),
PercentageChange AS (
    SELECT 
        a.country,
        a.year,
        a.GDP,
        a.taxes,
        ROUND(((a.GDP - b.GDP) / b.GDP) * 100, 2) AS GDP_Percentage_Change,
        ROUND(((a.taxes - b.taxes) / b.taxes) * 100, 2) AS Taxes_Percentage_Change,
        LEAD(ROUND(((a.taxes - b.taxes) / b.taxes) * 100, 2)) OVER (PARTITION BY a.country ORDER BY a.year) AS Taxes_Percentage_Change_Next_Year
    FROM 
        RankedData a
    LEFT JOIN 
        RankedData b ON a.country = b.country AND a.rn = b.rn + 1
)
SELECT 
    country,
    year,
    GDP,
    taxes,
    GDP_Percentage_Change,
    Taxes_Percentage_Change,
    Taxes_Percentage_Change_Next_Year
FROM 
    PercentageChange
WHERE 
    GDP_Percentage_Change IS NOT NULL 
    AND Taxes_Percentage_Change IS NOT NULL
ORDER BY 
    country, year;



--1.	Rostou v průběhu let mzdy ve všech odvětvích, nebo v některých klesají?
WITH yearly_avg AS (
    SELECT 
        payroll_year, 
        industry_branch_code, 
        ROUND(AVG(value), 0) AS avg_value
    FROM 
        czechia_payroll
    GROUP BY 
        payroll_year, 
        industry_branch_code
)
SELECT 
    current_year.payroll_year AS year,
    current_year.industry_branch_code,
    current_year.avg_value AS current_avg,
    previous_year.avg_value AS previous_avg,
    CASE 
        WHEN current_year.avg_value > previous_year.avg_value THEN 'roste'
        WHEN current_year.avg_value < previous_year.avg_value THEN 'klesa'
        ELSE 'zadna_zmena'
    END AS trend
FROM 
    yearly_avg current_year
LEFT JOIN 
    yearly_avg previous_year
ON 
    current_year.industry_branch_code = previous_year.industry_branch_code
    AND current_year.payroll_year = previous_year.payroll_year + 1
ORDER BY 
    current_year.industry_branch_code, 
    current_year.payroll_year;


--2. Kolik je možné si koupit litrů mléka a kilogramů chleba za první a poslední srovnatelné období v dostupných datech cen a mezd?
   WITH payroll_avg AS (
    SELECT 
        payroll_year, 
        industry_branch_code, 
        ROUND(AVG(value), 0) AS avg_value
    FROM 
        czechia_payroll
    WHERE 
        payroll_year IN (2006, 2018)
    GROUP BY 
        payroll_year, 
        industry_branch_code
),
price_avg AS (
    SELECT 
        YEAR(date_from) AS year, 
        category_code, 
        ROUND(AVG(value), 0) AS avg_price
    FROM 
        czechia_price
    WHERE 
        category_code IN (111301, 114201)
        AND YEAR(date_from) IN (2006, 2018)
    GROUP BY 
        YEAR(date_from), 
        category_code
),
ratio_calc AS (
    SELECT 
        p.payroll_year AS year,
        p.industry_branch_code,
        p.avg_value AS avg_payroll,
        pr.avg_price AS avg_price,
        pr.category_code,
        ROUND(p.avg_value / pr.avg_price, 2) AS ratio
    FROM 
        payroll_avg p
    JOIN 
        price_avg pr
    ON 
        p.payroll_year = pr.year
    ORDER BY 
        p.industry_branch_code, 
        p.payroll_year
)
SELECT 
    year,
    category_code,
    ROUND(AVG(ratio), 2) AS avg_ratio
FROM 
    ratio_calc
GROUP BY 
    year, 
    category_code
ORDER BY 
    category_code, 
    year;

--3. Která kategorie potravin zdražuje nejpomaleji (je u ní nejnižší percentuální meziroční nárůst)?
WITH yearly_avg AS (
    SELECT 
        YEAR(date_from) AS year, 
        category_code, 
        AVG(value) AS avg_price
    FROM 
        czechia_price
    GROUP BY 
        YEAR(date_from), 
        category_code
),
percent_change AS (
    SELECT 
        current_year.year,
        current_year.category_code,
        ROUND(current_year.avg_price, 2) AS current_avg_price,
        ROUND(previous_year.avg_price, 2) AS previous_avg_price,
        ROUND(((current_year.avg_price - previous_year.avg_price) / previous_year.avg_price) * 100, 2) AS percent_change
    FROM 
        yearly_avg current_year
    JOIN 
        yearly_avg previous_year
    ON 
        current_year.category_code = previous_year.category_code
        AND current_year.year = previous_year.year + 1
)
SELECT 
    category_code,
    AVG(percent_change) AS avg_percent_change
FROM 
    percent_change
GROUP BY 
    category_code
ORDER BY 
    avg_percent_change ASC
LIMIT 1;

--4. Existuje rok, ve kterém byl meziroční nárůst cen potravin výrazně vyšší než růst mezd (větší než 10 %)?
WITH yearly_price_avg AS (
    SELECT 
        YEAR(date_from) AS year, 
        AVG(value) AS avg_price
    FROM 
       czechia_price
    WHERE 
        YEAR(date_from) BETWEEN 2006 AND 2018
    GROUP BY 
        YEAR(date_from)
),
yearly_wage_avg AS (
    SELECT 
        payroll_year AS year, 
        AVG(value) AS avg_wage
    FROM 
        czechia_payroll
    WHERE 
        payroll_year BETWEEN 2006 AND 2018
    GROUP BY 
        payroll_year
),
price_wage_growth AS (
    SELECT 
        p.year,
        p.avg_price,
        w.avg_wage,
        LAG(p.avg_price) OVER (ORDER BY p.year) AS prev_avg_price,
        LAG(w.avg_wage) OVER (ORDER BY w.year) AS prev_avg_wage
    FROM 
        yearly_price_avg p
    JOIN 
        yearly_wage_avg w ON p.year = w.year
)
SELECT 
    year,
    ROUND(((avg_price - prev_avg_price) / prev_avg_price) * 100, 2) AS price_growth,
    ROUND(((avg_wage - prev_avg_wage) / prev_avg_wage) * 100, 2) AS wage_growth
FROM 
    price_wage_growth
WHERE 
    prev_avg_price IS NOT NULL 
    AND prev_avg_wage IS NOT NULL
    AND ((avg_price - prev_avg_price) / prev_avg_price) * 100 > ((avg_wage - prev_avg_wage) / prev_avg_wage) * 100 + 10
ORDER BY 
    year;


--5. Má výška HDP vliv na změny ve mzdách a cenách potravin? Neboli, pokud HDP vzroste výrazněji v jednom roce, projeví se to na cenách potravin či mzdách ve stejném nebo následujícím roce výraznějším růstem?
WITH yearly_avg AS (
    SELECT 
        payroll_year, 
        industry_branch_code, 
        ROUND(AVG(value), 0) AS avg_value
    FROM 
        czechia_payroll
    WHERE 
        payroll_year BETWEEN 2006 AND 2018
        AND industry_branch_code IS NOT NULL
    GROUP BY 
        payroll_year, 
        industry_branch_code
),
price_changes AS (
    SELECT 
        current_year.payroll_year AS year,
        current_year.industry_branch_code,
        current_year.avg_value AS current_avg,
        previous_year.avg_value AS previous_avg,
        ROUND(((current_year.avg_value - previous_year.avg_value) / previous_year.avg_value) * 100, 2) AS percent_change,
        CASE 
            WHEN current_year.avg_value > previous_year.avg_value THEN 'roste'
            WHEN current_year.avg_value < previous_year.avg_value THEN 'klesa'
            ELSE 'zadna_zmena'
        END AS trend
    FROM 
        yearly_avg current_year
    LEFT JOIN 
        yearly_avg previous_year
    ON 
        current_year.industry_branch_code = previous_year.industry_branch_code
        AND current_year.payroll_year = previous_year.payroll_year + 1
    WHERE 
        current_year.payroll_year BETWEEN 2006 AND 2018
),
gdp_changes AS (
    SELECT 
        YEAR,
        ROUND(GDP, 2) AS GDP,
        ROUND(LAG(GDP) OVER (ORDER BY YEAR), 2) AS Previous_GDP,
        ROUND(((GDP - LAG(GDP) OVER (ORDER BY YEAR)) / LAG(GDP) OVER (ORDER BY YEAR)) * 100, 2) AS GDP_Change_Percentage
    FROM 
        economies 
    WHERE 
        country = 'czech republic' 
        AND YEAR BETWEEN 2006 AND 2018
)
SELECT 
    p.year,
    p.industry_branch_code,
    p.current_avg,
    p.previous_avg,
    p.percent_change AS price_percent_change,
    p.trend,
    g.GDP,
    g.Previous_GDP,
    g.GDP_Change_Percentage AS gdp_percent_change
FROM 
    price_changes p
JOIN 
    gdp_changes g
ON 
    p.year = g.YEAR
ORDER BY 
    p.industry_branch_code, 
    p.year;

Odpovědi na otázky:
--1.	Rostou v průběhu let mzdy ve všech odvětvích, nebo v některých klesají?
--Výsledky hovoří, že se mzdy napříč lety 2000-2021 zvedají ve všech odvětvích. Nicméně musíme vzít v úvahu, že jsou zde kritické roky, ve kterých mzdy klesaly v téměř všech odvětvích. Globální finanční krize v letech 2008-2009 vedla k masivním ztrátám pracovních míst a snížení platů, zejména v odvětvích, která byla přímo zasažená kolapsem trhu s nemovitostmi a finančními institucemi.
--Nejvíce utrpěl finanční sektor, stavebnictví a výroba
--Dalšími kritickými lety byl rok 2020-2021, kdy pandemie Covid-19 vedla k celosvětovému lockdownu, ztrátě pracovních míst a snížení platů v mnoha sektorech. Mnoho zaměstnanců bylo nuceno pracovat na zkrácený úvazek nebo bylo dočasně či trvale propuštěno.
--Nejvíce bylo zasaženo pohostinství, cestovní ruch, maloobchod či zábavní průmysl a služby.
--Naopak v covidových letech značně rostly mzdy v následujících odvětvích: administrativní činnost, zdravotní a sociální péče, informační a komunikační činnost, doprava a skladování a distributoři energií.

--2. Kolik je možné si koupit litrů mléka a kilogramů chleba za první a poslední srovnatelné období v dostupných datech cen a mezd?
--Rok 2006-1204ks bochníků chleba, 1376 litrů mléka
--Rok 2018-1265ks bochníků chleba, 1518 litrů mléka

--3. Která kategorie potravin zdražuje nejpomaleji (je u ní nejnižší percentuální meziroční nárůst)?
--Nejmenší meziroční nárůst cen- cukr krystal  -1,9%.

--4. Existuje rok, ve kterém byl meziroční nárůst cen potravin výrazně vyšší než růst mezd (větší než 10 %)?
--Z dat dat vyplývá, že tuto podmínku splňovaly roky 2003 a 2017.
--2013	 ceny +5.55, mzdy -5.95 
--2017	ceny + 9.98, mzdy -1.26 

--5. Má výška HDP vliv na změny ve mzdách a cenách potravin? Neboli, pokud HDP vzroste výrazněji v jednom roce, projeví se to na cenách potravin či mzdách ve stejném nebo následujícím roce výraznějším růstem?
--Hypotéza říká, že by měla bát korelace mezi růstem/poklesem HDP a cenami potravin/výší mezd. 
--Z dostupných dat toto nelze jednoznačně potvrdit ani v jednom případě.
